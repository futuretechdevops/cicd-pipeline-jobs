pipeline {
    agent any
    tools { 
        maven 'Maven-360' 
        jdk 'JAVA-11' 
    }
    /*environment {
        PATH = "$PATH:/opt/apache-maven-3.8.2/bin"
    }*/

    stages {
        stage('Clone the Code') {
            steps {
                git 'https://github.com/futuretechdevops/hello-world.git'
            }
        }
        stage('MVN Build and Publish the Unit Test Results') {
            steps {
                sh 'mvn clean install'
            }
            post {
                always {
                    junit(
                        allowEmptyResults: true,
                        testResults: '**/target/surefire-reports/*.xml'
                    )
                }
            }
        }
        stage ('Code Quality') {
            environment {
                scannerHome = tool 'sonar-scanner-4.7'
            }
            steps {
                withSonarQubeEnv('SonarQube-Server-CE-9.8') {
                    sh "${scannerHome}/bin/sonar-scanner \
                    -D sonar.projectKey=cicd-demo \
                    -D sonar.exclusions=vendor/**,resources/**,**/*.java"
                }
            }
        }
        stage('SonarQube Quality Gates Check'){
            steps {
                timeout(time: 15, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        stage('Artifact-Upload') {
            steps {
                echo "build-version ${env.POM_VERSION}"
                script {
                    env.POM_VERSION = sh(returnStdout: true, script: "cat pom.xml  |grep 'version' |head -1 |awk -F '[><]' '{print \$3}'").trim()
                    env.RELEASE_VERSION = sh(returnStdout: true, script: "cat pom.xml  |grep 'version' |head -1 |awk -F '[><]' '{print \$3}' |awk -F '[-]' '{print \$2}'").trim()
                    sh '[[ -d webapp/target2 ]] && echo "target2 directory exist" || mkdir webapp/target2'
                    sh '[[ $(ls -A webapp/target2) ]] && rm -rf webapp/target2/* || echo "target2 empty directory"'
                    sh 'cp webapp/target/webapp.war webapp/target2/$BUILD_NUMBER-$RELEASE_VERSION-webapp.war' 
                    
                    if (env.RELEASE_VERSION == 'RELEASE') {
                        env.RELEASE_VERSION = "Release"
                        echo "${env.RELEASE_VERSION}"
                    }
                    else {
                        env.RELEASE_VERSION = "Snapshot"
                        echo "${env.RELEASE_VERSION}"
                    }
                    rtServer (
                        id: "jfrog", 
                        url: "http://10.10.0.5:8082",
                        credentialsId: "4fe16cb0-df33-4b63-a117-68c127eacd40"
                    )
                    rtUpload (
                        serverId: 'jfrog',
                        spec: '''{
                            "files": [
                                {
                               "pattern": "webapp/target2/*.war",
                               "target": "artifactory/\$RELEASE_VERSION/com/example/maven-project/webapp/\$POM_VERSION/"
                                }
                            ]
                        }''',
                        buildName: "$JOB_NAME",
                        buildNumber: "$BUILD_NUMBER"
                    )
                }
                stash includes: '**/target/*.war', name: "$JOB_NAME-WARfile"
                stash includes: 'Dockerfile', name: "$JOB_NAME-Dockerfile"
            }
        }
        stage('docker-build/tag/push') {
            agent {
                label 'docker'
            }
            steps {
                unstash "$JOB_NAME-WARfile"
                unstash "$JOB_NAME-Dockerfile"
                //sh 'printenv'
                //sh 'hostname -i && pwd && ls && whoami'
                sh 'docker build -t futuretechdevops/tomcat:\$BUILD_NUMBER-\$RELEASE_VERSION . -f Dockerfile'
                sh 'docker push futuretechdevops/tomcat:\$BUILD_NUMBER-\$RELEASE_VERSION'
            }
        }
        stage('docker-run || Deployment') {
            agent {
                label 'docker'
            }
            steps {
                sh 'docker stop tomcat || true && docker rm tomcat || true'
                sh 'docker run -d --name tomcat -p 8090:8090 futuretechdevops/tomcat:\$BUILD_NUMBER-\$RELEASE_VERSION'
            }
        }
    }
    post { 
        always { 
            echo 'I will always say Hello again!'
        }
        success {
            echo 'I succeeded!'
        }
        unstable {
            echo 'I am unstable :/'
        }
        failure {
            echo 'I failed :('
        }
        changed {
            echo 'Things were different before...'
        }
    }
}
